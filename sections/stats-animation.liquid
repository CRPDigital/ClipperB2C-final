{% comment %}
  Stats Counters â€“ flexible section
{% endcomment %}

<section
  id="stats-{{ section.id }}"
  class="stats-section"
  style="
    --stats-bg: {{ section.settings.bg_color }};
    --stats-fg: {{ section.settings.text_color }};
    --stats-border: {{ section.settings.border_color }};
  "
>
  <div class="stats-container">
    {% if section.settings.heading != blank %}
      <h3 class="stats-heading">{{ section.settings.heading }}</h3>
    {% endif %}

    <div class="stats-grid cols-{{ section.settings.columns_desktop }}">
      {% for block in section.blocks %}
        {% assign val = block.settings.value | default: 0 %}
        <div class="stat-card" {{ block.shopify_attributes }}>
          <div class="stat-number"
               data-target="{{ val | escape }}"
               data-duration="{{ section.settings.animation_duration | times: 1000 }}">
            {% if block.settings.prefix != blank and block.settings.prefix != "-" %}
              <span class="prefix">{{ block.settings.prefix }}</span>
            {% endif %}
            <span class="value">0</span>
            {% if block.settings.suffix != blank and block.settings.suffix != "-" %}
              <span class="suffix">{{ block.settings.suffix }}</span>
            {% endif %}
          </div>
          {% if block.settings.label != blank %}
            <h4 class="stat-label">{{ block.settings.label }}</h4>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <style>
    #stats-{{ section.id }} {
      background: var(--stats-bg);
      color: var(--stats-fg);
      padding: {{ section.settings.pad_y }}px 0;
    }
    #stats-{{ section.id }} .stats-container {
      max-width: {{ section.settings.max_width }}px;
      margin: 0 auto;
      padding: 0 20px;
    }
    #stats-{{ section.id }} .stats-heading {
      text-align: center;
      margin: 0 0 24px;
      line-height: 1.2;
    }
    #stats-{{ section.id }} .stats-grid {
      display: grid;
      gap: 16px;
    }
    #stats-{{ section.id }} .stats-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
    #stats-{{ section.id }} .stats-grid.cols-3 { grid-template-columns: repeat(2, 1fr); }
    #stats-{{ section.id }} .stats-grid.cols-4 { grid-template-columns: repeat(2, 1fr); }

    @media (min-width: 768px) {
      #stats-{{ section.id }} .stats-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
      #stats-{{ section.id }} .stats-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
      #stats-{{ section.id }} .stats-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    }

    #stats-{{ section.id }} .stat-card {
      border: 1px solid var(--stats-border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: transparent;
    }
    #stats-{{ section.id }} .stat-number {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      font-weight: 700;
      font-size: clamp(28px, 5vw, 44px);
      line-height: 1;
      margin-bottom: 8px;
    }
    #stats-{{ section.id }} .stat-label {
      opacity: 0.85;
      margin: 0;
    }
    #stats-{{ section.id }} .prefix,
    #stats-{{ section.id }} .suffix { opacity: 0.8; font-weight: 600; }
  </style>

  <script>
    (function() {
      const root = document.getElementById('stats-{{ section.id }}');
      if (!root) return;

      const cards = root.querySelectorAll('.stat-number');
      const animate = el => {
        if (el.dataset.animated) return;
        el.dataset.animated = "true";
        const target = parseFloat(el.getAttribute('data-target')) || 0;
        const duration = parseInt(el.getAttribute('data-duration')) || 1000;
        const valueEl = el.querySelector('.value');
        const startTime = performance.now();

        const format = (n) => {
          {% if section.settings.thousand_separator %}
            return Math.round(n).toLocaleString(undefined);
          {% else %}
            return Math.round(n);
          {% endif %}
        };

        function tick(now) {
          const progress = Math.min((now - startTime) / duration, 1);
          const current = target * progress;
          valueEl.textContent = format(current);
          if (progress < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      };

      const io = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) animate(entry.target);
        });
      }, { threshold: 0.3 });

      cards.forEach(c => io.observe(c));
    })();
  </script>
</section>

{% schema %}
{
  "name": "Stats counters",
  "tag": "section",
  "class": "section-stats-counters",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Our achievements"
    },
    {
      "type": "range",
      "id": "pad_y",
      "label": "Vertical padding",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "page-width",
          "label": "t:options.page"
        },
        {
          "value": "full-width",
          "label": "t:options.full"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "checkbox",
      "id": "mobile_section_width_enabled",
      "label": "t:settings.mobile_section_width_enabled",
      "default": false
    },
    {
      "type": "select",
      "id": "mobile_section_width",
      "label": "t:settings.mobile_section_width",
      "options": [
        {
          "value": "page-width",
          "label": "t:options.page"
        },
        {
          "value": "full-width",
          "label": "t:options.full"
        }
      ],
      "default": "full-width",
      "visible_if": "{{ section.settings.mobile_section_width_enabled }}"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Columns (desktop)",
      "default": "4",
      "options": [
        {
          "value": "2",
          "label": "2"
        },
        {
          "value": "3",
          "label": "3"
        },
        {
          "value": "4",
          "label": "4"
        }
      ]
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Card border",
      "default": "#e5e5e5"
    },
    {
      "type": "checkbox",
      "id": "thousand_separator",
      "label": "Use thousand separator",
      "default": true
    },
    {
      "type": "range",
      "id": "animation_duration",
      "label": "Animation duration (s)",
      "min": 0,
      "max": 5,
      "step": 0.1,
      "default": 1.2
    }
  ],
  "blocks": [
    {
      "type": "stat",
      "name": "Stat",
      "limit": 12,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Years of knitting experience"
        },
        {
          "type": "number",
          "id": "value",
          "label": "Value",
          "default": 90
        },
        {
          "type": "text",
          "id": "prefix",
          "label": "Prefix (optional)",
          "default": "-"
        },
        {
          "type": "text",
          "id": "suffix",
          "label": "Suffix (optional)",
          "default": "-"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stats counters",
      "blocks": [
        {
          "type": "stat",
          "settings": {
            "label": "Years of knitting experience",
            "value": 90,
            "prefix": "-",
            "suffix": "-"
          }
        },
        {
          "type": "stat",
          "settings": {
            "label": "Brands",
            "value": 3,
            "prefix": "-",
            "suffix": "-"
          }
        },
        {
          "type": "stat",
          "settings": {
            "label": "Countries",
            "value": 28,
            "prefix": "-",
            "suffix": "-"
          }
        },
        {
          "type": "stat",
          "settings": {
            "label": "Tonnes of yarn per year.",
            "value": 167,
            "prefix": "-",
            "suffix": "-"
          }
        }
      ]
    }
  ]
}
{% endschema %}
